// Product Modal - Product detail with carousel, zoom, and physics
import { Product, products } from '../data/products';
import { modalBiscuitConfigs } from '../data/biscuitConfig';
import { loadMatter, getMatter, createBiscuitBody, createWalls, applyForceAtPosition } from '../physics/PhysicsWorld';

export class ProductModal {
  private modalElement: HTMLElement | null = null;
  private engine: any = null;
  private render: any = null;
  private biscuits: any[] = [];
  private boundaryCheckInterval: number | null = null;
  private currentCarouselIndex = 0;
  private currentZoomLevel = 0;
  private imagePosition = { x: 0, y: 0 };
  private cleanupCarouselDrag: (() => void) | null = null;
  private originalBodyOverflow: string = '';
  private originalBodyPosition: string = '';
  private scrollPosition: number = 0;
  private escapeKeyHandler: ((e: KeyboardEvent) => void) | null = null;

  async open(productId: number): Promise<void> {
    const product = products[productId];
    if (!product) return;

    // Block body scroll
    this.blockBodyScroll();

    // Add escape key handler
    this.setupEscapeKeyHandler();

    // Create modal HTML
    this.createModalHTML(product, productId);

    // Setup modal interactions
    this.setupModalClose();
    this.setupModalNavigation();
    this.setupCarouselDrag();
    this.updateCarouselSlide();

    // Load Matter.js and create physics
    await loadMatter();
    this.createPhysicsWorld(product.type);
  }

  private createModalHTML(product: Product, _productIndex: number): void {

    const modalHTML = `
      <div id="productModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <div class="modal-top-header">
              <h2 class="trademark-name">${product.name}</h2>
              <button class="close-modal" onclick="closeProductModal()">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -1.5 130 130" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g clip-path="url(#clip-close)"> <path d="M62.3649 76.0626C51.1451 86.1072 40.1732 95.8365 29.311 105.687C23.0183 111.394 16.9509 117.348 10.6729 123.069C9.0008 124.632 7.07937 125.903 4.98785 126.828C3.95649 127.261 1.72933 126.828 1.22143 126.035C0.549397 124.982 0.748089 123.114 1.11261 121.74C1.37779 120.738 2.45753 119.908 3.27208 119.104C18.7627 103.852 34.2604 88.6091 49.7649 73.3765C51.5045 71.6681 53.2942 70.0117 55.293 68.1144C48.5175 60.6052 41.7314 53.3593 35.2529 45.844C24.9134 33.8442 14.7813 21.6659 4.56355 9.56215C4.19212 9.12226 3.87261 8.64079 3.49773 8.20091C1.70969 6.08722 0.449103 3.80904 2.48505 1.24507C4.00964 -0.674661 7.65428 -0.387934 10.1921 2.22366C16.5124 8.7258 22.6693 15.3855 28.7745 22.0963C39.9226 34.3429 50.9837 46.6692 62.092 58.9522C62.5675 59.399 63.0731 59.8124 63.6053 60.1895C72.1948 51.9798 80.6892 43.7969 89.2545 35.6841C99.1881 26.2803 109.157 16.9135 119.16 7.58361C122.912 4.07666 125.921 3.44455 128.224 5.49071C130.61 7.61046 130.388 11.1519 126.582 14.9489C116.293 25.2161 105.755 35.2339 95.2268 45.2629C87.2065 52.9054 79.0583 60.4164 70.5224 68.3992C77.4586 75.5733 84.0927 82.724 91.0479 89.5439C97.7284 96.0945 104.782 102.265 111.594 108.681C114.257 111.095 116.751 113.69 119.058 116.449C120.918 118.763 121.193 121.636 118.906 123.919C116.652 126.17 114.043 125.375 111.869 123.67C107.71 120.58 103.724 117.264 99.9275 113.736C88.3069 102.355 76.8913 90.7657 65.4012 79.2517C64.4925 78.3424 63.6243 77.3883 62.3649 76.0626Z" fill="#ffffff"></path> </g> <defs> <clipPath id="clip-close"> <rect width="129" height="127" fill="white" transform="translate(0.777344)"></rect> </clipPath> </defs> </g>
                </svg>
              </button>          
            </div>
            <nav class="nav">
              <a id="info-tab" href="#info" class="nav-link active">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="-26 0 159 159" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g clip-path="url(#clip-info-tab)"> <path d="M28.9494 29.1077C27.1162 28.6805 25.2856 28.2401 23.4485 27.8286C20.7969 27.2379 19.2802 25.5019 19.1588 22.8916C18.9566 18.5237 18.9179 14.1407 19.0223 9.76887C19.0879 6.91314 21.2362 5.28922 23.5727 4.44846C26.6076 3.35697 29.8171 2.27801 32.9938 2.13493C47.4601 1.48319 61.9382 1.05716 76.4184 0.776907C81.6553 0.675831 85.3742 2.03917 86.0863 9.48861C86.5122 13.9392 86.9198 18.393 87.2303 22.8528C87.4016 25.3226 85.8185 27.3384 83.0914 28.3662C82.2434 28.6581 81.3751 28.8879 80.4936 29.0539C79.6469 29.2383 78.7871 29.3552 77.8079 29.5233C77.8571 31.6662 79.2177 32.6632 80.6098 33.5853C82.2926 34.7011 84.0228 35.7472 85.7456 36.8013C96.948 43.645 102.476 53.9449 103.966 66.6986C105.989 84.0194 106.137 101.432 106.455 118.833C106.564 124.783 106.491 130.742 106.282 136.689C106.164 140.158 105.801 143.614 105.198 147.03C104.279 152.198 101.418 155.018 95.8486 155.738C87.5046 156.817 79.1245 157.881 70.7286 158.242C53.0731 159.001 35.4891 157.624 18.0134 155.067C14.9125 154.594 11.8745 153.774 8.95608 152.624C4.85067 151.027 2.01587 148.095 1.48029 143.468C1.13309 140.476 0.591064 137.468 0.641602 134.476C0.887073 119.767 1.02159 105.046 1.75078 90.3576C2.27585 79.7296 2.92159 69.0523 5.48065 58.6364C7.62949 49.888 12.7176 43.0655 19.5881 37.4748C21.8485 35.637 24.2749 33.9963 26.645 32.2964C27.6387 31.5829 28.6836 30.9404 29.7055 30.2656C29.454 29.8779 29.2019 29.492 28.9494 29.1077ZM35.7425 29.6682C35.9742 34.8179 32.4358 37.9269 28.6717 40.9034C27.4404 41.8768 26.2649 42.9236 25.0894 43.9653C19.6667 48.7677 15.31 54.3828 14.3872 61.7219C12.9518 73.1721 11.6215 84.6652 10.9868 96.18C10.1847 110.742 10.1334 125.345 9.73962 139.93C9.64707 143.378 10.1992 144.307 13.7139 144.925C17.7943 145.643 21.9181 146.158 26.0412 146.586C48.0003 148.869 69.9574 149.075 91.9034 146.359C94.9882 145.978 95.9261 144.809 95.8605 141.718C95.7207 135.102 95.5592 128.484 95.6084 121.868C95.7397 104.247 96.0423 86.6231 94.6502 69.0332C94.0733 61.7481 92.6405 54.7142 87.4679 49.1983C84.9081 46.5327 82.0505 44.17 78.9519 42.1565C74.4717 39.1826 70.7411 35.8884 70.602 29.6689L35.7425 29.6682ZM25.4466 22.1605C43.2344 22.4608 61.0261 21.8674 78.7543 20.3824C78.4485 16.0893 78.18 12.3252 77.9011 8.42462C75.7076 8.0744 73.4971 7.83674 71.2793 7.7125C60.0558 7.65736 48.8324 7.59166 37.6143 7.79185C34.286 7.85157 30.9355 8.59717 27.6643 9.33621C24.9733 9.94529 24.5835 10.5662 24.6741 13.3766C24.764 16.1542 25.1486 18.9227 25.4466 22.1605Z" fill="#ffffff"></path> <path d="M21.656 95.966C21.656 87.9954 21.614 80.0255 21.6717 72.0563C21.7085 67.0215 23.5365 65.0596 28.5312 64.8614C38.0671 64.4833 47.6076 64.2338 57.1475 63.949C62.3115 63.7947 67.4756 63.6261 72.641 63.5763C74.3159 63.5277 75.9889 63.7143 77.6121 64.1309C80.3687 64.906 81.1563 66.1473 81.2613 69.0207C81.682 80.5775 82.0325 92.1376 82.5438 103.69C82.8464 110.529 83.4751 117.354 83.7948 124.192C83.7902 126.093 83.5631 127.986 83.1194 129.834C83.015 130.512 82.679 131.133 82.169 131.592C81.6584 132.051 81.0047 132.319 80.3188 132.35C76.4372 132.719 72.5497 133.329 68.6662 133.319C56.9834 133.288 45.3065 133.034 33.6276 132.794C31.9434 132.737 30.2707 132.494 28.6396 132.072C25.7018 131.347 23.9349 129.643 23.1098 126.47C22.0991 122.586 21.9939 118.766 22.0957 114.825C22.2545 108.541 22.1385 102.252 22.1385 95.9647L21.656 95.966ZM29.0213 70.546C29.7814 88.3183 30.531 105.822 31.2963 123.76H74.7865V72.0792C59.4387 70.5178 44.4459 70.9464 29.0213 70.546Z" fill="#ffffff"></path> <path d="M50.3017 107.252H43.9169C43.2448 107.252 42.5701 107.288 41.9006 107.244C38.7075 107.035 36.6591 105.402 36.6781 103.109C36.6965 100.869 38.4333 99.3258 41.5949 99.0901C47.179 98.6747 52.7723 98.3682 58.3656 98.0997C59.5966 98.0564 60.8277 98.1831 62.024 98.4765C64.2556 99.0015 65.58 100.498 65.6561 102.328C65.7369 104.274 64.3789 105.974 62.0213 106.543C60.6003 106.856 59.1511 107.023 57.6961 107.043C55.2336 107.12 52.7669 107.065 50.3017 107.065V107.252Z" fill="#ffffff"></path> <path d="M51.0919 77.4488C54.2272 77.4488 57.3631 77.4022 60.4971 77.4619C63.9186 77.5275 66.0473 79.1999 65.9559 81.627C65.8667 83.9898 63.5616 85.7226 60.2629 85.6438C53.9975 85.4935 47.7353 85.2224 41.4726 84.9822C40.8015 84.9612 40.1348 84.8647 39.4852 84.6947C37.2037 84.0811 36.0775 82.6089 36.3052 80.6254C36.5192 78.7634 37.7413 77.5932 40.0096 77.4599C42.4649 77.3155 44.9321 77.4008 47.3966 77.3903C48.6279 77.3851 49.86 77.3903 51.0919 77.3903V77.4488Z" fill="#ffffff"></path> <path d="M52.219 111.863C54.1224 111.863 56.0305 111.788 57.9292 111.892C59.035 111.972 60.1262 112.193 61.1762 112.548C62.5145 112.981 63.3211 114.128 62.9004 115.401C62.5656 116.412 61.5377 117.229 60.7153 118.026C60.3227 118.25 59.8651 118.331 59.4192 118.258C54.6161 118.043 49.8123 117.829 45.0125 117.553C43.3106 117.455 42.374 116.371 42.2165 114.737C42.0648 113.169 43.2417 112.023 45.1792 111.743C45.8455 111.673 46.5162 111.658 47.1849 111.696C48.0802 111.711 48.9742 111.772 49.8694 111.792C50.6531 111.809 51.4368 111.795 52.2204 111.795L52.219 111.863Z" fill="#ffffff"></path> <path d="M49.6967 89.1689C53.4116 89.146 55.2651 90.2105 55.3989 92.0398C55.5302 93.8499 53.8308 95.395 50.9042 95.6647C49.2415 95.7454 47.5756 95.5905 45.9561 95.2053C44.6178 94.9427 43.63 93.8545 44.0002 92.5268C44.3447 91.4097 45.1048 90.4678 46.1235 89.8948C47.3824 89.2884 48.9419 89.3028 49.6967 89.1689Z" fill="#ffffff"></path> </g> <defs> <clipPath id="clip-info-tab"> <rect width="106.327" height="158.177" fill="white" transform="translate(0.36499 0.32373)"></rect> </clipPath> </defs> </g>
                </svg>
              </a>
              <a id="image-tab" href="#image" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -0.5 157 157" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g clip-path="url(#clip-image-tab)"> <path d="M52.3816 53.2803C55.1411 55.8328 58.5193 56.971 63.3378 56.971C63.3609 56.9733 63.3841 56.9733 63.4071 56.971C63.5554 56.9573 63.7373 56.9443 63.9431 56.93C64.4894 56.8917 65.2377 56.8377 65.9725 56.7285C68.0872 56.4465 70.1236 55.7401 71.9607 54.6514C73.7984 53.5626 75.3985 52.1137 76.6666 50.391C77.8757 48.6838 78.7308 46.7497 79.18 44.7038C79.6293 42.6579 79.6636 40.5421 79.2817 38.4825C78.4758 33.7759 76.2393 30.7682 72.6442 29.5456C70.1922 28.7181 67.5946 28.4137 65.0189 28.6518C62.4429 28.8901 59.9447 29.6656 57.6843 30.9288C55.5114 32.1174 53.6139 33.7547 52.1166 35.7328C50.6193 37.711 49.5563 39.9853 48.9975 42.4058C48.0136 46.6334 49.1522 50.2935 52.3816 53.2803ZM65.6786 36.7853C65.8081 36.7853 65.9414 36.7853 66.0702 36.7853C68.2458 36.7853 69.9644 37.0531 70.7955 39.2416C71.2163 40.4323 71.2739 41.7219 70.9593 42.9453C70.6453 44.1688 69.9741 45.27 69.0323 46.1076C66.6754 48.2565 61.6374 48.8304 58.8631 47.2671C57.0875 46.2674 56.5464 45.0234 56.995 42.9739C57.9109 38.7892 60.6697 36.8243 65.6786 36.7853Z" fill="#000000"></path> <path d="M33.8781 154.127C35.4776 154.062 37.1353 153.997 38.7439 153.997C48.5751 154.046 57.5597 154.144 66.2106 154.297C80.0629 154.541 94.2058 154.841 108.241 155.188C109.387 155.25 110.526 155.41 111.645 155.665C112.195 155.774 112.746 155.882 113.294 155.97C113.329 155.976 113.364 155.979 113.399 155.979H120.022C120.055 155.979 120.087 155.976 120.119 155.971C121.447 155.776 122.779 155.598 124.111 155.422C126.991 155.042 129.97 154.649 132.865 154.034C146.162 151.213 156.827 137.547 156.639 123.568C156.513 114.22 156.538 104.712 156.562 95.5162C156.579 88.9168 156.595 82.0937 156.558 75.3818C156.522 69.2458 156.305 63.0122 156.096 56.9867L155.962 53.1159C155.914 51.6651 155.871 50.2135 155.832 48.761C155.703 43.9841 155.567 39.0447 155.098 34.208C154.602 29.443 153.714 24.7274 152.444 20.1096C148.91 6.97957 136.391 0.810472 125.556 0.525123C122.459 0.443873 119.324 0.663455 116.291 0.875355C114.009 1.03525 111.651 1.20035 109.34 1.23415C103.051 1.32645 96.6533 1.36416 90.4696 1.40316C82.3298 1.45256 73.9129 1.50465 65.6352 1.6769L64.3894 1.70357C52.5224 1.95057 40.2502 2.20529 28.2239 3.14194C15.2578 4.15139 6.66227 10.3836 2.67488 21.667C2.00579 23.383 1.61373 25.1952 1.51358 27.0353L1.44887 32.4667C1.25144 48.3338 1.04689 64.7419 1.09479 80.8815C1.11551 88.129 1.35888 95.4922 1.5945 102.613C1.72396 106.605 1.86313 110.731 1.95829 114.789C2.06315 119.209 2.10007 122.925 1.94019 126.69C1.35762 140.351 13.2278 153.461 26.8393 154.196C29.1897 154.322 31.5737 154.223 33.8781 154.127ZM9.50715 38.6314C9.42682 32.8611 10.7874 27.1627 13.4648 22.0564C15.909 17.5194 19.5086 14.6898 23.876 13.8747C30.7885 12.5845 37.5567 11.4106 44.3728 11.226C61.6953 10.7554 79.314 10.4798 96.351 10.2133C104.941 10.0784 113.531 9.9361 122.121 9.78621C126.717 9.70041 131.27 11.0564 136.473 14.049C142.152 17.3133 143.962 23.2004 144.984 28.5291C147.13 39.7195 148.078 49.1009 147.969 58.0514C147.925 61.5805 147.893 65.1183 147.872 68.666C147.628 68.4405 147.391 68.2065 147.136 67.9939C143.776 65.1918 140.32 62.3947 136.977 59.69C132.948 56.4296 128.782 53.06 124.761 49.6585C119.514 45.2229 116.452 45.3361 111.653 50.1448C100.239 61.5776 88.5646 73.2271 77.2737 84.4929L64.5085 97.2329L64.2826 97.0463C63.8664 96.7025 63.5285 96.4236 63.188 96.1493C61.404 94.7057 59.6228 93.2588 57.8445 91.8092C53.5076 88.2772 49.0166 84.6255 44.5385 81.1103C41.2891 78.5597 38.964 78.5948 35.9624 81.2325C27.163 88.9675 18.269 96.8539 9.62554 104.523C9.53751 84.1692 9.47284 61.6297 9.50715 38.6314ZM10.5163 112.695C12.1993 111.275 13.8788 109.851 15.5549 108.422C18.7228 105.729 21.9982 102.944 25.2547 100.253C28.7418 97.3694 32.3466 94.4723 35.833 91.6728C37.2687 90.5184 38.7105 89.3575 40.1582 88.1907C42.0937 89.7585 44.014 91.3133 45.9192 92.8532C50.8918 96.8734 55.5894 100.669 60.3483 104.586C64.1202 107.691 66.4106 107.576 69.7773 104.122C70.9055 102.963 72.0156 101.786 73.1251 100.612C74.5777 99.0704 76.0794 97.4773 77.5973 95.9595C89.0643 84.4981 100.746 72.8676 112.044 61.6199L116.97 56.7156C117.445 56.2411 117.957 55.7848 118.368 55.4156L118.407 55.3818C120.511 57.0354 122.6 58.6821 124.674 60.3218C130.877 65.2204 136.736 69.8477 142.814 74.4569C144.354 75.5281 146.045 76.3627 147.83 76.9334C147.792 89.1469 147.836 101.358 147.881 113.3C147.896 116.932 147.909 120.564 147.92 124.195C147.948 132.995 140.891 142.63 132.508 145.233C126.235 147.137 119.685 147.952 113.139 147.642C104.227 147.274 95.1651 146.843 86.4052 146.427C82.7583 146.254 79.1107 146.08 75.4625 145.907H75.4321L65.5827 145.903C60.2781 145.9 54.9739 145.898 49.6704 145.898C43.9145 145.898 38.1588 145.902 32.403 145.911H32.3343C25.8043 145.911 20.9075 144.263 16.9285 140.73C12.0485 136.394 9.75571 130.455 9.71234 122.038C9.69745 119.217 9.68321 116.33 9.66897 113.393C9.95443 113.165 10.2399 112.928 10.5163 112.695Z" fill="#000000"></path> </g> <defs> <clipPath id="clip-image-tab"> <rect width="156" height="156" fill="white" transform="translate(0.777344)"></rect> </clipPath> </defs> </g>
                </svg>
              </a>
              <a id="inside-pack-tab" href="#inside-pack" class="nav-link">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -4 160 160" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M138.184 97.8078C139.094 105.535 139.956 112.648 140.752 119.768C140.888 120.982 140.683 122.23 140.769 123.453C141.073 127.743 138.691 130.153 135.03 131.556C126.245 134.924 117.506 138.436 108.606 141.476C98.8597 144.804 88.9733 147.733 79.098 150.669C77.3869 151.144 75.5814 151.167 73.8585 150.734C56.5969 146.248 39.5624 141.055 23.1238 134.055C20.5156 133.047 17.9883 131.84 15.5641 130.446C14.2359 129.494 13.1891 128.201 12.5343 126.704C11.9843 125.56 12.0219 124.072 12.0193 122.736C11.9989 114.088 11.979 105.439 12.1122 96.7925C12.1933 96.1387 12.0667 95.4759 11.7497 94.8983C11.4328 94.3214 10.9417 93.8586 10.3467 93.5757C8.38915 92.479 6.52967 91.2156 4.78835 89.7998C1.22903 86.7964 0.702511 83.2443 3.20776 79.3155C4.23007 77.8427 5.39266 76.4722 6.67917 75.2232C10.0049 71.7446 13.3855 68.3245 16.8556 64.7673C12.9674 61.2822 9.29076 57.9948 5.62448 54.696C4.58526 53.8387 3.60305 52.9147 2.68409 51.9296C0.202479 49.024 0.530055 46.1538 3.57021 43.7969C5.16643 42.5597 6.85182 41.434 8.46903 40.227C20.967 30.8841 33.4376 21.5051 45.9697 12.208C48.4303 10.4403 50.983 8.80433 53.6173 7.30762C56.7769 5.44886 59.7585 5.75548 62.605 8.19177C66.1026 11.1853 69.7117 14.0477 73.292 16.9428C74.2424 17.7114 75.2611 18.3926 76.4595 19.2656C78.0584 17.4521 79.589 15.6971 81.1405 13.961C84.2089 10.5279 87.2839 7.09994 90.3654 3.67691C93.2532 0.465455 95.2019 -0.173334 98.9529 1.81078C105.785 5.42523 112.651 9.03923 119.147 13.2063C131.14 20.8993 142.878 28.9891 154.717 36.9223C155.369 37.3611 155.992 37.842 156.581 38.3622C159.472 40.9094 159.797 43.5789 157.307 46.6007C153.304 51.4675 148.983 56.0322 143.707 59.5823C143.344 59.8265 143.022 60.1312 142.428 60.613C146.05 64.425 149.572 68.1558 153.126 71.8582C154.373 73.1538 155.773 74.3037 156.957 75.6492C160.083 79.2019 160.034 82.6996 156.846 86.1762C154.391 88.9637 151.386 91.2123 148.019 92.7816C144.559 94.3417 141.243 96.2326 138.184 97.8078ZM129.5 62.2019C128.109 61.371 127.187 60.8025 126.248 60.2623C114.692 53.6071 103.155 46.9183 91.5638 40.3254C87.4768 38.0013 83.1909 36.0245 79.1177 33.6774C76.9236 32.4127 75.284 32.8286 73.3045 34.1367C61.242 42.1197 49.1128 50.0025 36.9935 57.8962C33.9231 59.8968 30.8068 61.8263 27.4634 63.9456C28.2733 64.4706 28.7144 64.8042 29.1981 65.0615C43.6724 72.6884 58.1926 80.2285 72.5957 87.9864C75.8045 89.7145 78.4948 90.1595 81.3558 87.6182C82.169 87.0209 83.0505 86.5221 83.9812 86.1329C97.3777 79.1074 110.776 72.084 124.175 65.064C125.834 64.1944 127.475 63.2914 129.5 62.2019ZM81.6892 25.7751C100.198 35.6629 117.443 46.8001 136.038 55.3994L147.727 43.5853C147.337 43.1704 146.92 42.7814 146.48 42.4204C135.503 35.0359 124.577 27.5733 113.51 20.328C108.83 17.2642 103.854 14.6516 99.0047 11.8516C97.4952 10.9794 96.2114 10.9984 94.8508 12.4266C90.5997 16.8812 86.216 21.2031 81.6892 25.7745V25.7751ZM19.8315 99.5189C20.6336 108.059 21.3669 115.753 22.0678 123.451C22.0842 124.013 22.286 124.555 22.6421 124.991C22.9983 125.426 23.4889 125.732 24.0368 125.859C24.9951 126.168 25.9119 126.6 26.859 126.954C40.839 132.183 55.2411 136.005 69.6671 139.741C70.496 139.884 71.3329 139.97 72.173 139.998V105.919C70.0071 108.297 68.3787 110.302 66.5232 112.072C64.6493 113.998 62.5733 115.716 60.3316 117.197C57.3295 119.016 53.9847 119.347 50.749 117.516C42.2603 112.714 33.7827 107.891 25.3159 103.047C23.6803 102.112 22.1425 101.014 19.8315 99.5182V99.5189ZM131.305 101.488C129.638 102.233 128.816 102.557 128.033 102.957C119.754 107.182 111.428 111.327 103.231 115.705C100.387 117.224 97.8548 117.245 95.3936 115.372C91.3807 112.317 87.4775 109.121 83.5316 105.979C82.7118 105.326 81.9111 104.65 80.9449 103.856C81.5914 116.312 82.2169 128.358 82.849 140.566C83.6628 140.352 84.4242 140.203 85.1462 139.953C89.8009 138.342 94.476 136.782 99.092 135.065C108.638 131.514 118.151 127.88 127.674 124.266C128.932 123.789 130.102 123.342 130.181 121.569C130.47 115.083 130.895 108.604 131.305 101.483V101.488ZM9.77849 83.7044L56.8345 109.981L70.6975 97.0517L21.8826 69.1449L9.77849 83.7044ZM85.8609 95.3912C89.9762 98.5875 93.8512 101.461 97.5588 104.535C99.4327 106.088 100.976 106.357 103.237 105.152C116.982 97.8275 130.812 90.6616 144.608 83.4314C145.567 82.9293 146.478 82.336 147.339 81.828L136.378 66.9593L85.8609 95.3912ZM56.532 15.9018C41.0372 25.4187 27.5219 37.3738 13.2675 47.2747L24.2939 58.7913L70.0701 27.8374L56.532 15.9018Z" fill="#ffffff"></path> </g>
                </svg>
              </a>
            </nav>        
          </div>
          <div class="modal-body">
            <section id="info" class="info-section active">
              <div class="info-container">
                <div class="ingridients-container">
                  <p><strong>Ingredientes: </strong>${product.ingredients.main}</p>
                  <p><strong>Contém: </strong>${product.ingredients.complement}</p>
                </div>
                <div class="package-labels">
                  <img src="${product.nutritionalTable}" alt="${product.name}_nutritional_table" class="nutritional-table-image" />
                  <img src="${product.frontLabel}" alt="${product.name}_front_label" class="front-label-image" />
                </div>            
              </div>
            </section>

            <section id="image" class="image-section">
              <div class="carousel-container">
                <div class="carousel">
                  <div class="carousel-images" id="carouselImages" title="Arraste para navegar ou use as setas">
                    ${product.images.map((img, idx) => `
                      <div class="carousel-slide ${idx === 0 ? 'active' : ''}">
                        <img src="${img}" alt="${product.name}" class="carousel-image" style="transform: scale(1) translate(0px, 0px);" />
                      </div>
                    `).join('')}
                  </div>
                  <button class="carousel-nav-btn prev" title="Imagem anterior"><svg xmlns="http://www.w3.org/2000/svg" viewBox="-16.5 0 93 93" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M10.7064 48.1102C17.149 53.632 23.1985 59.3212 29.7705 64.3264C38.6199 71.0663 47.8545 77.3022 56.9606 83.7028C59.4671 85.465 60.3893 87.9492 59.0937 90.1007C57.7619 92.3106 54.8812 92.8397 52.5066 91.0623C40.8894 82.3658 29.2283 73.7159 17.7673 64.8127C12.7745 60.9344 8.23591 56.4772 3.4663 52.3075C-0.143558 49.1571 -0.122472 46.0926 3.55171 43.0531C16.0899 32.683 28.6195 22.303 41.1402 11.9132C45.2489 8.48711 49.1474 4.8116 53.2534 1.37829C54.2138 0.544365 55.4274 0.0587681 56.6979 0C58.5672 0.0656338 59.2918 2.26633 58.0047 4.03385C56.7172 5.79958 55.2582 7.4337 53.6492 8.9124C40.2941 21.1724 26.9112 33.4021 13.5004 45.6017C12.703 46.3309 11.8937 47.0457 10.7064 48.1102Z" fill="#ffffff"></path> </g></svg></button>
                  <button class="carousel-nav-btn next" title="Próxima imagem"><svg xmlns="http://www.w3.org/2000/svg" viewBox="-15 0 91 91" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M50.4346 45.4919C44.987 41.1817 40.1398 37.3172 35.2626 33.4855C27.2756 27.2103 19.1692 21.0806 11.3247 14.6347C8.05416 11.9437 5.30221 8.62145 2.3651 5.53797C1.10427 4.21414 0.00225389 2.50952 1.49805 0.913964C3.15793 -0.858149 4.96936 0.25769 6.35488 1.636C21.2597 16.4653 39.7113 26.6458 56.0863 39.5501C60.9117 43.3529 61.5404 46.5544 57.4547 51.2597C56.19 52.7677 54.8172 54.1815 53.3468 55.4898C42.6584 64.6667 32.0394 73.9329 21.1403 82.8538C17.6407 85.7181 13.3954 87.6905 9.40551 89.9187C8.72554 90.2987 6.9344 90.1445 6.82807 89.8354C6.43427 88.6973 6.00249 87.0334 6.55054 86.2097C8.70464 82.9667 10.8522 79.5598 13.6876 76.9607C20.5305 70.6887 27.7726 64.8532 34.8263 58.809C38.9743 55.2543 43.0627 51.6292 47.1936 48.0535C48.0974 47.2711 49.0701 46.5657 50.4346 45.4919Z" fill="#ffffff"></path> </g></svg></button>
                  <div class="zoom-controls">
                    <button class="zoom-btn" title="Aumentar zoom">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -2.5 159 159" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g clip-path="url(#clip-zoom-in)"> <path d="M14.5584 89.0236C18.4681 93.6319 23.5945 97.0394 29.3482 98.8536C34.6977 100.546 40.2627 101.455 45.8709 101.552C54.1115 101.739 62.3897 100.355 71.1899 97.3279C77.2152 95.2655 82.9732 92.487 88.3413 89.0516C88.4689 89.3108 88.6249 89.5558 88.8062 89.7806C98.6488 101.542 109.39 112.293 118.602 121.262C127.92 130.332 137.524 139.404 146.562 147.919C147.982 149.195 149.492 150.368 151.078 151.428C151.532 151.749 151.991 152.069 152.442 152.396C153.183 152.982 154.089 153.318 155.032 153.359C155.728 153.357 156.402 153.119 156.946 152.684C158.44 151.526 158.732 149.642 157.689 147.883L157.16 146.983C156.104 145 154.817 143.151 153.326 141.473C147.01 134.934 140.206 128.106 133.102 121.18C125.232 113.508 117.189 105.75 109.411 98.2487C105.177 94.166 100.946 90.0815 96.7192 85.9936C96.1603 85.453 95.6391 84.8598 95.1353 84.286C95.011 84.1437 94.8873 84.0033 94.7649 83.8656L94.9656 83.6434C95.2557 83.3185 95.5484 82.9975 95.8554 82.6953C103.119 75.6263 107.098 66.7872 107.68 56.4243C108.692 38.4186 102.638 23.1455 89.6882 11.0282C83.3403 4.94621 75.1088 1.22828 66.3631 0.493103C57.8576 -0.323972 49.2761 0.660071 41.1736 3.38146C28.8548 7.59665 18.375 15.6449 10.0269 27.3015C2.58018 37.6942 -0.35512 49.0752 1.29352 61.1269C2.63393 70.9822 6.97568 80.1072 14.5584 89.0236ZM53.5404 12.2042C54.8614 12.0795 56.1823 11.9565 57.5033 11.8352C77.2088 11.0633 88.9506 24.6094 93.3707 37.5369C96.3915 46.3741 97.0319 53.8414 95.3872 61.0456C94.3058 66.0536 91.8672 70.6638 88.3407 74.3696C84.2411 78.6452 79.334 82.0585 73.9057 84.4095C61.8295 89.8287 50.0896 91.6046 38.0182 89.8365C30.2788 88.7039 24.3965 85.2938 20.0353 79.4119C15.5524 73.3689 12.7304 67.6261 11.4075 61.8637C9.48402 53.9318 10.2635 45.582 13.6214 38.1464C17.4814 29.5504 22.6028 23.2111 29.2783 18.7672C34.5797 15.2375 39.4531 13.4045 44.6153 13.0003C47.594 12.7644 50.6167 12.4791 53.5404 12.2042Z" fill="#ffffff"></path> <path d="M20.9158 50.6481C20.8311 51.3752 21.0303 52.107 21.4715 52.6899C21.9128 53.2729 22.5619 53.6617 23.2826 53.7749C24.5126 54.0906 25.7779 54.246 27.0474 54.2375C31.9092 54.0497 36.8486 53.8061 41.6255 53.5709L46.3046 53.3421C47.1069 53.3031 47.9092 53.2603 48.8158 53.2122L49.6356 53.1692L49.6673 53.4513C49.7198 53.9126 49.7586 54.2519 49.7884 54.5924C49.9132 56.0219 50.0364 57.4513 50.1581 58.8808C50.4664 62.4826 50.7856 66.2053 51.1456 69.8656C51.1769 71.095 51.5271 72.2945 52.1616 73.3465C52.954 74.4213 54.0921 75.188 55.3832 75.5168C55.5466 75.5486 55.7127 75.5649 55.8792 75.5655C57.1924 75.5655 58.3295 74.535 58.7394 72.9014C59.0875 71.6688 59.2465 70.39 59.2108 69.1092C59.0411 66.5276 58.7808 63.9149 58.5283 61.3885C58.4311 60.4142 58.3357 59.4395 58.242 58.4645L57.6762 52.5454L57.9176 52.5181C58.3644 52.4661 58.705 52.4272 59.0463 52.3934L63.8012 51.921C68.0971 51.4967 72.5386 51.058 76.9043 50.5824C78.1165 50.5183 79.2944 50.1579 80.3363 49.5324C80.8025 49.1734 81.1794 48.7107 81.4364 48.1808C81.6942 47.6508 81.8263 47.0681 81.8211 46.4784C81.6987 45.4244 80.6691 44.3756 79.7638 43.8473C78.8398 43.4262 77.818 43.2671 76.8104 43.3873C73.7728 43.5036 70.1725 43.6602 66.5048 43.9357C64.1606 44.1118 61.8637 44.3465 59.4329 44.5954C58.5928 44.682 57.7452 44.7685 56.89 44.8552L56.8583 44.3783C56.8123 43.6922 56.7741 43.119 56.7418 42.5452L56.4762 37.8018C56.2988 34.6113 56.1171 31.4212 55.931 28.2317C55.8222 26.4123 54.8716 25.2731 53.2534 25.0184C52.9221 24.9655 52.5836 24.9802 52.2581 25.0615C51.9325 25.1428 51.6267 25.289 51.3587 25.4914C50.9638 25.8099 50.6353 26.2033 50.3922 26.6494C50.1491 27.0954 49.9961 27.5851 49.9419 28.0906C49.7698 29.4454 49.6965 30.8111 49.7224 32.1765C49.7062 35.5372 49.7088 38.8986 49.7113 42.3509V45.7571C48.7569 45.8604 47.8283 45.963 46.9179 46.0631C44.5511 46.323 42.3158 46.572 40.0759 46.7779C34.6178 47.2763 29.0587 47.7331 23.8647 48.1522C21.6158 48.3348 21.0182 49.6104 20.9158 50.6481Z" fill="#ffffff"></path> </g> <defs> <clipPath id="clip-zoom-in"> <rect width="158" height="154" fill="white" transform="translate(0.777344)"></rect> </clipPath> </defs> </g>
                      </svg>
                    </button>
                    <button class="zoom-btn" title="Resetar zoom">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 -14 179 179" fill="none"><g stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <g clip-path="url(#clip-reset-zoom"> <path d="M150.623 103.636C148.858 103.225 146.502 103.451 145.306 106.835C143.604 111.644 140.529 115.536 137.746 118.709C129.821 127.745 119.481 134.093 107.019 137.576C97.6028 140.207 86.4064 142.551 74.7526 139.977C57.3729 136.137 43.2279 126.557 32.7116 111.499C28.0394 104.808 25.3576 98.4163 24.5131 91.9506C23.0129 80.9426 23.5155 69.7536 25.9964 58.9252C26.6187 56.2632 27.4517 53.5879 28.3417 50.7319C28.4747 50.3071 28.6088 49.8765 28.7439 49.44C29.3377 50.5601 29.8483 51.4998 30.4226 52.4416L30.5691 52.6794C31.6685 54.5713 32.894 56.3867 34.238 58.1129C36.1174 60.4195 38.8158 61.116 40.9551 59.8468C42.6441 58.8432 43.9679 56.448 42.1249 53.0003C40.0396 49.1023 37.2479 43.9922 34.1472 39.0294C31.8455 35.3442 28.9669 34.3466 24.8144 35.7973C17.8114 38.2446 11.0957 40.874 5.44972 43.1208C3.84767 43.7529 2.46897 44.8481 1.48974 46.267C0.658856 47.5688 0.824715 49.7167 1.45421 50.9534C2.30264 52.6274 4.13638 53.0919 6.36073 52.197C10.7231 50.4396 15.1553 48.7847 19.6891 47.1042C20.3621 46.8542 21.0836 46.6486 21.8073 46.4533C17.8666 55.5888 15.6889 65.892 15.1575 77.8952C14.526 92.1361 16.6833 102.696 22.1493 112.134C31.6008 128.45 45.6482 140.213 63.9023 147.096C69.345 149.134 75.0676 150.324 80.8702 150.628C82.3462 150.71 83.8475 150.751 85.3325 150.751C93.9006 150.706 102.417 149.416 110.615 146.922C124.527 142.821 135.611 136.141 144.5 126.489C148.832 121.787 151.581 117.339 153.149 112.489C153.606 111.221 153.879 109.894 153.962 108.549C154.048 105.143 152.195 103.997 150.623 103.636Z" fill="#ffffff"></path> <path d="M177.792 69.6636C176.872 68.453 175.276 67.9323 173.413 68.2349C171.382 68.5604 169.467 69.8738 168.216 70.9165C166.111 72.6738 164.098 74.5665 161.967 76.5679L161.895 76.6337C161.741 76.7788 161.585 76.9233 161.429 77.0704C162.249 70.0606 162.18 62.9755 161.226 55.9828C159.312 41.5989 152.548 28.3021 142.057 18.2977C131.583 8.35446 118.029 2.27283 102.858 0.708808C87.2457 -0.89752 71.5953 1.70918 56.3439 8.46511C51.5366 10.596 45.9876 13.378 41.3154 17.8559C40.0522 19.1485 39.0501 20.6734 38.3642 22.3468C37.8646 23.4826 38.512 25.7965 39.7567 26.368C40.3876 26.5925 41.06 26.6758 41.7265 26.6124C42.393 26.5489 43.0377 26.3404 43.6152 26.0009C44.3559 25.5452 45.0484 25.0154 45.6827 24.4198C46.1211 24.014 46.5877 23.6394 47.0784 23.2989C66.3073 10.7223 86.8228 6.45397 108.052 10.6071C121.053 13.1539 131.664 19.4434 139.587 29.2994C148.726 40.666 152.958 54.1844 152.168 69.4787C151.972 72.2859 151.63 75.0814 151.144 77.8527C151.044 78.4906 150.945 79.1284 150.847 79.7669C150.05 78.8765 149.231 77.9569 148.458 77.0196C146.787 74.9889 145.124 72.9498 143.47 70.9015L143.37 70.7779C142.189 69.3206 141.007 67.8633 139.8 66.3865C139.28 65.7076 138.694 65.0819 138.05 64.5194C136.334 63.1044 134.342 63.0029 132.723 64.2473C131.965 64.8024 131.438 65.6185 131.244 66.5388C131.05 67.4591 131.202 68.4185 131.67 69.2334C132.309 70.4915 133.059 71.6897 133.911 72.8131C138.747 79.0438 143.495 85.0767 147.503 90.156C149.192 92.296 150.781 93.2508 152.656 93.2508C153.962 93.1942 155.238 92.8356 156.382 92.2023C163.569 88.549 170.083 83.6975 175.645 77.856C176.612 76.8758 177.406 75.7381 177.993 74.4923C178.821 72.6797 178.747 70.9165 177.792 69.6636Z" fill="#ffffff"></path> </g> <defs> <clipPath id="clip-reset-zoom"> <rect width="178" height="151" fill="white" transform="translate(0.777344)"></rect> </clipPath> </defs> </g>
                      </svg>
                    </button>
                  </div>
                </div>
                <div class="carousel-dots" id="carouselDots">
                  ${product.images.map((_, idx) => `
                    <span class="dot ${idx === 0 ? 'active' : ''}" data-index="${idx}"></span>
                  `).join('')}
                </div>
              </div>
            </section>
            
            <section id="inside-pack" class="inside-pack-section">
              <div class="physics-container">
                <p class="inside-package-text"><strong>O que tem dentro do pacote ?</strong><br>${product.insidePackageDescription}</p>
                <canvas id="physicsCanvas"></canvas>
              </div>
            </section>          
          </div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHTML);
    this.modalElement = document.getElementById('productModal');
  }

  private setupModalClose(): void {
    const closeBtn = document.getElementById('closeProductModal');
    if (closeBtn) {
      closeBtn.addEventListener('click', () => this.close());
    }

    // Close on backdrop click
    this.modalElement?.addEventListener('click', (e) => {
      if (e.target === this.modalElement) {
        this.close();
      }
    });

    // Setup carousel indicators
    const indicators = document.querySelectorAll('.carousel-dots .dot');
    indicators.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = parseInt(dot.getAttribute('data-index') || '0');
        this.currentCarouselIndex = index;
        this.updateCarouselSlide();
      });
    });

    // Setup physics buttons
    const shakeBtn = document.getElementById('shakeBtn');
    const resetBtn = document.getElementById('resetBtn');
    
    shakeBtn?.addEventListener('click', () => this.shakeBiscuits());
    resetBtn?.addEventListener('click', () => this.resetBiscuits());

    // Setup carousel navigation buttons
    const prevBtn = document.querySelector('.carousel-nav-btn.prev');
    const nextBtn = document.querySelector('.carousel-nav-btn.next');
    
    prevBtn?.addEventListener('click', () => this.changeCarouselImage(-1));
    nextBtn?.addEventListener('click', () => this.changeCarouselImage(1));

    // Setup carousel dots
    const dots = document.querySelectorAll('.carousel-dots .dot');
    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        this.currentCarouselIndex = index;
        this.currentZoomLevel = 0;
        this.imagePosition = { x: 0, y: 0 };
        this.updateCarouselSlide();
      });
    });

    // Setup zoom buttons in image section
    const zoomInBtn = document.querySelector('.zoom-controls .zoom-btn[title="Aumentar zoom"]');
    const resetZoomBtn = document.querySelector('.zoom-controls .zoom-btn[title="Resetar zoom"]');
    
    zoomInBtn?.addEventListener('click', () => this.zoomImage(1));
    resetZoomBtn?.addEventListener('click', () => this.resetZoom());
  }

  private setupModalNavigation(): void {
    const navLinks = document.querySelectorAll('.modal-content .nav-link');
    const sections = document.querySelectorAll('.modal-content section');

    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const currentLink = e.currentTarget as HTMLAnchorElement;
        const targetId = currentLink.getAttribute('href')?.substring(1);
        
        // Update active nav link
        navLinks.forEach(nav => nav.classList.remove('active'));
        currentLink.classList.add('active');
        
        // Show/hide sections
        sections.forEach(section => {
          if (section.id === targetId) {
            section.classList.add('active');
          } else {
            section.classList.remove('active');
          }
        });
      });
    });
  }

  private setupCarouselDrag(): void {
    const carouselContainer = document.getElementById('carouselImages');
    if (!carouselContainer) return;

    let isDragging = false;
    let isImageDrag = false;
    let startX = 0;
    let startY = 0;
    let endX = 0;
    let initialImagePos = { x: 0, y: 0 };

    const handleStart = (e: MouseEvent | TouchEvent) => {
      isDragging = true;

      const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;

      startX = clientX;
      startY = clientY;
      endX = clientX;

      const activeImg = document.querySelector('.carousel-slide.active .carousel-image') as HTMLElement;
      if (activeImg && this.currentZoomLevel > 0) {
        isImageDrag = true;
        initialImagePos = { ...this.imagePosition };
        activeImg.style.cursor = 'grabbing';
      } else {
        isImageDrag = false;
        carouselContainer.style.cursor = 'grabbing';
      }

      e.preventDefault();
    };

    const handleMove = (e: MouseEvent | TouchEvent) => {
      if (!isDragging) return;

      const clientX = 'touches' in e ? e.touches[0].clientX : e.clientX;
      const clientY = 'touches' in e ? e.touches[0].clientY : e.clientY;

      endX = clientX;

      if (isImageDrag && this.currentZoomLevel > 0) {
        const deltaX = (clientX - startX) / 2;
        const deltaY = (clientY - startY) / 2;

        this.imagePosition = {
          x: initialImagePos.x + deltaX,
          y: initialImagePos.y + deltaY
        };

        this.updateImageTransform();
      }

      e.preventDefault();
    };

    const handleEnd = () => {
      if (!isDragging) return;

      isDragging = false;

      const activeImg = document.querySelector('.carousel-slide.active .carousel-image') as HTMLElement;
      if (activeImg) {
        activeImg.style.cursor = this.currentZoomLevel > 0 ? 'move' : 'zoom-in';
      }
      carouselContainer.style.cursor = 'grab';

      if (!isImageDrag) {
        const dragDistance = endX - startX;
        const threshold = 50;

        if (Math.abs(dragDistance) > threshold) {
          if (dragDistance > 0) {
            this.changeCarouselImage(-1);
          } else {
            this.changeCarouselImage(1);
          }
        }
      }

      isImageDrag = false;
    };

    carouselContainer.style.cursor = 'grab';

    carouselContainer.addEventListener('mousedown', handleStart);
    carouselContainer.addEventListener('touchstart', handleStart, { passive: false });

    document.addEventListener('mousemove', handleMove);
    document.addEventListener('touchmove', handleMove, { passive: false });

    document.addEventListener('mouseup', handleEnd);
    document.addEventListener('touchend', handleEnd);

    const images = carouselContainer.querySelectorAll('img');
    images.forEach(img => {
      img.addEventListener('dragstart', (e) => e.preventDefault());
      img.style.userSelect = 'none';
      (img.style as any).webkitUserSelect = 'none';
    });

    // Pinch-to-zoom support
    let initialDistance = 0;

    const handleTouchStart = (e: TouchEvent) => {
      if (e.touches.length === 2) {
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        initialDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);
      }
    };

    const handlePinchMove = (e: TouchEvent) => {
      if (e.touches.length === 2 && initialDistance > 0) {
        e.preventDefault();
        const touch1 = e.touches[0];
        const touch2 = e.touches[1];
        const currentDistance = Math.hypot(touch2.clientX - touch1.clientX, touch2.clientY - touch1.clientY);

        const scale = currentDistance / initialDistance;

        if (scale > 1.2 && this.currentZoomLevel === 0) {
          this.zoomImage(1);
        } else if (scale < 0.8 && this.currentZoomLevel === 1) {
          this.zoomImage(-1);
        }
      }
    };

    const handlePinchEnd = (e: TouchEvent) => {
      if (e.touches.length < 2) {
        initialDistance = 0;
      }
    };

    images.forEach(img => {
      img.addEventListener('touchstart', handleTouchStart, { passive: false });
      img.addEventListener('touchmove', handlePinchMove, { passive: false });
      img.addEventListener('touchend', handlePinchEnd);
    });

    this.cleanupCarouselDrag = () => {
      carouselContainer.removeEventListener('mousedown', handleStart);
      carouselContainer.removeEventListener('touchstart', handleStart);
      document.removeEventListener('mousemove', handleMove);
      document.removeEventListener('touchmove', handleMove);
      document.removeEventListener('mouseup', handleEnd);
      document.removeEventListener('touchend', handleEnd);

      images.forEach(img => {
        img.removeEventListener('touchstart', handleTouchStart);
        img.removeEventListener('touchmove', handlePinchMove);
        img.removeEventListener('touchend', handlePinchEnd);
      });
    };
  }

  private zoomImage(direction: number): void {
    const newLevel = Math.max(0, Math.min(1, this.currentZoomLevel + direction));
    this.currentZoomLevel = newLevel;
    this.imagePosition = { x: 0, y: 0 };
    this.updateImageTransform();
  }

  private resetZoom(): void {
    this.currentZoomLevel = 0;
    this.imagePosition = { x: 0, y: 0 };
    this.updateImageTransform();
  }

  private updateImageTransform(): void {
    const activeSlide = document.querySelector('.carousel-slide.active');
    if (activeSlide) {
      const img = activeSlide.querySelector('.carousel-image') as HTMLImageElement;
      if (img) {
        const scale = this.currentZoomLevel === 0 ? 1 : 2;
        img.style.transform = `scale(${scale}) translate(${this.imagePosition.x}px, ${this.imagePosition.y}px)`;
        img.style.cursor = this.currentZoomLevel > 0 ? 'move' : 'zoom-in';
      }
    }
  }

  private changeCarouselImage(direction: number): void {
    const slides = document.querySelectorAll('.carousel-slide');
    const totalSlides = slides.length;

    this.currentCarouselIndex = (this.currentCarouselIndex + direction + totalSlides) % totalSlides;
    this.currentZoomLevel = 0;
    this.imagePosition = { x: 0, y: 0 };

    this.updateCarouselSlide();
  }

  private updateCarouselSlide(): void {
    const slides = document.querySelectorAll('.carousel-slide');
    const indicators = document.querySelectorAll('.carousel-dots .dot');

    slides.forEach((slide, index) => {
      slide.classList.toggle('active', index === this.currentCarouselIndex);
    });

    indicators.forEach((dot, index) => {
      dot.classList.toggle('active', index === this.currentCarouselIndex);
    });

    this.updateImageTransform();
  }

  private createPhysicsWorld(productType: 'baunilha' | 'parmesao' | 'cafe_cacau'): void {
    const Matter = getMatter();
    if (!Matter) return;

    const canvas = document.getElementById('physicsCanvas') as HTMLCanvasElement;
    if (!canvas) return;

    const containerRect = canvas.parentElement!.getBoundingClientRect();

    canvas.width = containerRect.width - 40;
    canvas.height = 305;

    const engine = Matter.Engine.create();
    engine.world.gravity.y = 0.5;

    const render = Matter.Render.create({
      canvas: canvas,
      engine: engine,
      options: {
        width: canvas.width,
        height: canvas.height,
        wireframes: false,
        background: '#fff8dc00'
      }
    });

    const walls = createWalls(canvas.width, canvas.height);
    const biscuits = this.createBiscuits(productType, canvas.width, canvas.height);

    Matter.World.add(engine.world, [...walls, ...biscuits]);

    this.engine = engine;
    this.render = render;
    this.biscuits = biscuits;

    this.setupPhysicsInteraction(canvas);
    this.setupBoundaryCheck(canvas);

    Matter.Engine.run(engine);
    Matter.Render.run(render);
  }

  private createBiscuits(productType: 'baunilha' | 'parmesao' | 'cafe_cacau', canvasWidth: number, _canvasHeight: number): any[] {
    const Matter = getMatter();
    if (!Matter) return [];

    const biscuits: any[] = [];
    const configs = modalBiscuitConfigs[productType];

    // Set physics properties based on product type
    const physicsProps = productType === 'parmesao' ? 
      { restitution: 0.2, friction: 0.5 } : 
      { restitution: 0.3, friction: 0.4 };

    configs.forEach((config) => {
      for (let i = 0; i < config.count; i++) {
        const x = Math.random() * (canvasWidth - 100) + 50;
        const y = Math.random() * 100 + 50;

        const biscuit = createBiscuitBody(x, y, config.image, {
          restitution: physicsProps.restitution,
          friction: physicsProps.friction
        });

        biscuits.push(biscuit);
      }
    });

    return biscuits;
  }

  private blockBodyScroll(): void {
    // Save current scroll position and body styles
    this.scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
    this.originalBodyOverflow = document.body.style.overflow;
    this.originalBodyPosition = document.body.style.position;
    
    // Apply scroll blocking styles
    document.body.style.overflow = 'hidden';
    document.body.style.position = 'fixed';
    document.body.style.top = `-${this.scrollPosition}px`;
    document.body.style.width = '100%';
    
    // Prevent touch scrolling on modal background
    document.body.addEventListener('touchmove', this.preventScroll, { passive: false });
  }

  private preventScroll = (e: TouchEvent): void => {
    // Allow scrolling within modal content
    const target = e.target as HTMLElement;
    if (!target.closest('.modal-content')) {
      e.preventDefault();
    }
  }

  private restoreBodyScroll(): void {
    // Remove touch scroll prevention
    document.body.removeEventListener('touchmove', this.preventScroll);
    
    // Restore original body styles
    document.body.style.overflow = this.originalBodyOverflow;
    document.body.style.position = this.originalBodyPosition;
    document.body.style.top = '';
    document.body.style.width = '';
    
    // Restore scroll position
    window.scrollTo(0, this.scrollPosition);
  }

  private setupEscapeKeyHandler(): void {
    this.escapeKeyHandler = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        this.close();
      }
    };
    document.addEventListener('keydown', this.escapeKeyHandler);
  }

  private removeEscapeKeyHandler(): void {
    if (this.escapeKeyHandler) {
      document.removeEventListener('keydown', this.escapeKeyHandler);
      this.escapeKeyHandler = null;
    }
  }

  private setupPhysicsInteraction(canvas: HTMLCanvasElement): void {
    const handleInteraction = (clientX: number, clientY: number) => {
      const rect = canvas.getBoundingClientRect();
      const x = clientX - rect.left;
      const y = clientY - rect.top;
      applyForceAtPosition(this.biscuits, x, y);
    };

    canvas.addEventListener('mousemove', (e) => handleInteraction(e.clientX, e.clientY));
    canvas.addEventListener('touchmove', (e) => {
      if (e.touches.length > 0) {
        handleInteraction(e.touches[0].clientX, e.touches[0].clientY);
      }
    }, { passive: true });
  }

  private setupBoundaryCheck(canvas: HTMLCanvasElement): void {
    const Matter = getMatter();
    if (!Matter) return;

    this.boundaryCheckInterval = window.setInterval(() => {
      if (!this.engine || !this.biscuits.length) {
        if (this.boundaryCheckInterval) {
          clearInterval(this.boundaryCheckInterval);
        }
        return;
      }

      this.biscuits.forEach((biscuit: any) => {
        const pos = biscuit.position;
        const margin = 10;
        let needsReset = false;
        let newX = pos.x;
        let newY = pos.y;

        if (pos.x < margin) {
          newX = margin + Math.random() * 50;
          needsReset = true;
        } else if (pos.x > canvas.width - margin) {
          newX = canvas.width - margin - Math.random() * 50;
          needsReset = true;
        }

        if (pos.y < margin) {
          newY = margin + Math.random() * 50;
          needsReset = true;
        } else if (pos.y > canvas.height - margin) {
          newY = canvas.height - margin - Math.random() * 50;
          needsReset = true;
        }

        if (needsReset) {
          Matter.Body.setPosition(biscuit, { x: newX, y: newY });
          Matter.Body.setVelocity(biscuit, { x: 0, y: 0 });
          Matter.Body.setAngularVelocity(biscuit, 0);
        }
      });
    }, 100);
  }

  private shakeBiscuits(): void {
    const Matter = getMatter();
    if (!Matter || !this.biscuits) return;

    this.biscuits.forEach((biscuit: any) => {
      const force = {
        x: (Math.random() - 0.5) * 0.01,
        y: (Math.random() - 0.5) * 0.01
      };
      Matter.Body.applyForce(biscuit, biscuit.position, force);
    });
  }

  private resetBiscuits(): void {
    const Matter = getMatter();
    if (!Matter || !this.biscuits || !this.engine) return;

    const canvas = document.getElementById('physicsCanvas') as HTMLCanvasElement;
    if (!canvas) return;

    this.biscuits.forEach((biscuit: any) => {
      const x = Math.random() * (canvas.width - 100) + 50;
      const y = Math.random() * 100 + 50;
      Matter.Body.setPosition(biscuit, { x, y });
      Matter.Body.setVelocity(biscuit, { x: 0, y: 0 });
    });
  }

  close(): void {
    // Restore body scroll
    this.restoreBodyScroll();

    // Remove escape key handler
    this.removeEscapeKeyHandler();

    // Cleanup physics
    if (this.boundaryCheckInterval) {
      clearInterval(this.boundaryCheckInterval);
    }

    const Matter = getMatter();
    if (Matter) {
      if (this.render) {
        Matter.Render.stop(this.render);
      }
      if (this.engine) {
        Matter.Engine.clear(this.engine);
      }
    }

    // Cleanup carousel drag
    if (this.cleanupCarouselDrag) {
      this.cleanupCarouselDrag();
    }

    // Remove modal
    if (this.modalElement) {
      document.body.removeChild(this.modalElement);
    }

    // Reset state
    this.modalElement = null;
    this.engine = null;
    this.render = null;
    this.biscuits = [];
    this.currentCarouselIndex = 0;
    this.currentZoomLevel = 0;
    this.imagePosition = { x: 0, y: 0 };
  }
}
