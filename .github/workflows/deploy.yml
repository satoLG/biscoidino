name: ğŸš€ Deploy with Testing

on:
  push:
    branches: [ main ]
  workflow_run:
    workflows: ["ğŸ§ª Automated Testing"]
    types:
      - completed

jobs:
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ§ª Run quick smoke tests
      run: |
        npx playwright install chromium
        npx playwright test --project=chromium navigation.spec.ts home-section.spec.ts

    - name: ğŸ—ï¸ Build for production
      run: npm run build

    - name: ğŸš€ Deploy to Vercel
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.ORG_ID }}
        vercel-project-id: ${{ secrets.PROJECT_ID }}
        vercel-args: '--prod'

  post-deploy-test:
    name: ğŸ” Post-Deployment Testing
    needs: deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ“¦ Install dependencies
      run: npm ci

    - name: ğŸ­ Install Playwright
      run: npx playwright install chromium

    - name: ğŸ” Test production deployment
      run: |
        # Replace with your actual production URL
        export PLAYWRIGHT_BASE_URL="https://your-production-url.vercel.app"
        npx playwright test --project=chromium navigation.spec.ts
      env:
        PLAYWRIGHT_BASE_URL: https://your-production-url.vercel.app